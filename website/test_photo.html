<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Contact Photo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .photo-container {
            margin: 20px 0;
            text-align: center;
        }
        .photo-container img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 50%;
            border: 2px solid #ddd;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .success {
            color: green;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Test Contact Photo Endpoint</h1>
    
    <div class="test-section">
        <h2>Test Photo by Unique ID</h2>
        <p>Enter a contact unique_id (e.g., C3355BD5-4F2E-4951-853F-ADE89BA1A97E:ABPerson)</p>
        <input type="text" id="uniqueIdInput" placeholder="Enter unique_id" value="C3355BD5-4F2E-4951-853F-ADE89BA1A97E:ABPerson">
        <button onclick="loadPhoto()">Load Photo</button>
        <div id="status"></div>
        <div class="photo-container" id="photoContainer"></div>
    </div>
    
    <div class="test-section">
        <h2>Quick Test Links</h2>
        <p>Click to test these known unique_ids:</p>
        <ul>
            <li><a href="#" onclick="testPhoto('C3355BD5-4F2E-4951-853F-ADE89BA1A97E:ABPerson'); return false;">C3355BD5-4F2E-4951-853F-ADE89BA1A97E:ABPerson</a></li>
            <li><a href="#" onclick="testPhoto('0029728F-89FA-4AFE-B2C9-4C2091629C18:ABPerson'); return false;">0029728F-89FA-4AFE-B2C9-4C2091629C18:ABPerson</a></li>
        </ul>
    </div>

    <script>
        // Get BASE_URL from config.js if available, otherwise use default
        let BASE_URL = window.BASE_URL || 'http://127.0.0.1:8888';
        
        function testPhoto(uniqueId) {
            document.getElementById('uniqueIdInput').value = uniqueId;
            loadPhoto();
        }
        
        async function loadPhoto() {
            const uniqueId = document.getElementById('uniqueIdInput').value.trim();
            const statusDiv = document.getElementById('status');
            const photoContainer = document.getElementById('photoContainer');
            
            if (!uniqueId) {
                statusDiv.innerHTML = '<div class="error">Please enter a unique_id</div>';
                photoContainer.innerHTML = '';
                return;
            }
            
            statusDiv.innerHTML = '<div>Loading...</div>';
            photoContainer.innerHTML = '';
            
            try {
                // URL encode the unique_id
                const encodedId = encodeURIComponent(uniqueId);
                const photoUrl = `${BASE_URL}/contact-photo/${encodedId}`;
                
                console.log('Fetching photo from:', photoUrl);
                
                const response = await fetch(photoUrl, {
                    credentials: 'include'  // Include cookies for authentication
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    statusDiv.innerHTML = `<div class="error">Error ${response.status}: ${errorText}</div>`;
                    photoContainer.innerHTML = '';
                    return;
                }
                
                // Get the image as blob
                const blob = await response.blob();
                console.log('Image blob:', blob.type, blob.size);
                
                // Create object URL and display
                const imageUrl = URL.createObjectURL(blob);
                photoContainer.innerHTML = `
                    <img src="${imageUrl}" alt="Contact Photo" onload="this.style.display='block'">
                    <p>Photo loaded successfully! (${blob.size} bytes, ${blob.type})</p>
                `;
                
                statusDiv.innerHTML = `<div class="success">âœ“ Photo loaded successfully!</div>`;
                
            } catch (error) {
                console.error('Error loading photo:', error);
                statusDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                photoContainer.innerHTML = '';
            }
        }
        
        // Load default photo on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Don't auto-load, let user click
        });
    </script>
</body>
</html>
